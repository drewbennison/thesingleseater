rsconnect::setAccountInfo(name='drewbennison', token='48EB9D6F563A1BA0BA1E0B012E783B31', secret='dw7rUtxus40Idj6Uc2oCPGavFs7Eb49Z0O9fQ3t/')
rm(list = ls())
library(data.table)
library(lubridate)
library(jsonlite)
library(RCurl)
library(tidyverse)
library(gt)
options(scipen=999)
library(data.table)
library(tidyverse)
library(readxl)
library(stringi)
d <- read_xlsx("C:/Users/drewb/Downloads/indycar-race-lapchart.xlsx")
d$ID <- seq.int(nrow(d))
start <- which(d$`Event:` == "Drivers in Race:")
stop <- which(d$`Event:` == "Pit Stop")
lapchart <- tibble()
#make one long lap chart
for(i in 1:length(start)) {
print(i)
temp_lapchart <- d %>% filter(ID >start[i] & ID < stop[i]-1) %>%
select(-ID)
temp_lapchart <- data.table(temp_lapchart)
temp_lapchart <- temp_lapchart[,c(-1,-2)]
if(i == 1){
lapchart <- temp_lapchart
} else{
lapchart <- cbind(lapchart, temp_lapchart)
}
print(temp_lapchart)
print(temp_lapchart)
}
#clean lapchart by renaming columns and remove NA columns
new_names <- as.character(c(1:ncol(lapchart)))
names(lapchart) <- new_names
x <- lapchart %>% select_if(~!is.na(.[1L]))
new_names <- as.character(c(1:ncol(x)))
names(x) <- new_names
#Get driver names for stat update
driver_names <- d %>% filter(ID >start[1] & ID < stop[1]-1) %>%
select(`Event:`)
driver_names$number <- stri_extract_first_regex(driver_names$`Event:`, "[0-9]+")
driver_names$name <- sub(".*-", "", driver_names$`Event:`)
driver_names$name <- gsub( ",.*$", "", driver_names$name )
driver_names$name <- trimws(driver_names$name)
driver_names <- driver_names %>% select(name, number)
#### Save clean lapchart and driver names ####
fwrite(x, "C:/Users/drewb/Desktop/Projects/thesingleseater/datasets/lap_charts/2021_r16_longbeach_lapchart.csv")
fwrite(driver_names, "C:/Users/drewb/Desktop/Projects/thesingleseater/datasets/lap_charts/2021_r16_longbeach_driver_names.csv")
library(data.table)
library(tidyverse)
library(lubridate)
dt <- fread("https://raw.githubusercontent.com/drewbennison/thesingleseater/master/datasets/master_backup/indycar_results.csv")
#Initialize elo ratings, k
elo_ratings_initial <- dt %>% select(driver) %>% unique() %>% mutate(EloRating=1500)
k <- 2
w <- 1 #season retention
q <- 7.5 #elo points per place difference
elo_ratings <- elo_ratings_initial
tracker <- tibble(driver=elo_ratings_initial$driver, date=ymd("2021-01-01"), year=2000, EloRating=1500, PreviousEloRating=1500)
k_optimization <- tibble(errorXWin=0, errorXWin2=0, season=year("2000-01-01"), type="None")
#Select variables we want
dt <- dt %>% select(year, raceNumber, driver, fin, st, date, type) %>%
mutate(date=mdy(date))
#Starting and ending year range
for(a in c(2008:2021)) {
current_year <- dt %>% filter(year==a) %>% select(raceNumber, driver, fin, st, date, type)
for(i in 1:max(current_year$raceNumber)) {
current_race <- current_year %>% filter(raceNumber==i, )
x <- current_race$driver
y <- current_race$driver
if(i == 1){
elo_ratings$EloRating <- w*elo_ratings$EloRating + (w-1)*1500
}
current_race_cross <- crossing(x, y) %>% left_join(current_race, by=c("x"="driver")) %>%
left_join(current_race, by=c("y"="driver")) %>% select(-raceNumber.y) %>% filter(x!=y) %>%
left_join(elo_ratings, by=c("x"="driver")) %>%
left_join(elo_ratings, by=c("y"="driver")) %>%
mutate("xWin" = ifelse(fin.x<fin.y,1,0),
"XexpectedWin" = (1/(1+10^((EloRating.y - (EloRating.x + q*(st.y-st.x)))/400))))
#Update elo ratings for race
elo <- current_race_cross %>% group_by(x) %>%
summarise("oldRating" = mean(EloRating.x),
"actualScore" = sum(xWin),
"expectedScore" = sum(XexpectedWin),
"newRating"= oldRating+k*(actualScore-expectedScore),
"date" = max(ymd(date.x)),
"type" = max(type.x))
for(j in 1:nrow(elo)) {
elo_ratings[elo_ratings$driver==elo$x[j],2] <- elo$newRating[j]
tracker <- add_row(tracker, driver=elo$x[j], date=elo$date[j], year=a, EloRating=elo$newRating[j], PreviousEloRating=elo$oldRating[j])
}
k_optimization <- add_row(k_optimization, errorXWin = current_race_cross$xWin, errorXWin2=current_race_cross$XexpectedWin, season=year(current_race_cross$date.x), type=current_race_cross$type.x)
}
}
fwrite(tracker,"C:/Users/drewb/Desktop/projects/thesingleseater/datasets/elo_ratings/elo_tracker.csv")
