# Predict Finishing Position in Race
Author: Kyle Bennison
Created: 2022-02-22

Test regression models using available inputs:
- Avg. SP
- Avg. FP
- Years Experience
- Team Name
- Manufacturer
- Track Type

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/Kyle/Documents/Kyle/Personal/Data/thesingleseater")
```


## Read in Data
```{r, warning=FALSE, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
library(lubridate)

# Get Elo
elo <- fread("https://raw.githubusercontent.com/drewbennison/thesingleseater/master/datasets/elo_ratings/elo_tracker.csv")

# Get drivers and races they'll be in this year
drivers_2022 <- fread("https://raw.githubusercontent.com/drewbennison/thesingleseater/master/datasets/indycar_2022_drivers_races.csv")

# Get team history from 2016 to 2022
team_history <- fread("https://raw.githubusercontent.com/drewbennison/thesingleseater/master/datasets/drivers_teams_2016-2022.csv")

# Get Results since 2008
results_history <- fread("https://raw.githubusercontent.com/drewbennison/thesingleseater/master/datasets/master_backup/indycar_results.csv")
```

## Create Tables
```{r}
# Calculate years of experience
driver_experience <- elo %>% 
  filter(year != 2000) %>% 
  group_by(driver) %>% distinct(year) %>% count() %>% 
  rename(years_experience = n)

# Get drivers current elo rating
driver_elo_current <- elo %>% 
  filter(year != 2000) %>% 
  group_by(driver) %>% 
  slice_max(order_by = date, n = 1)

# Simplifiy team names over the years
team_history <- team_history %>% 
  mutate(owner = case_when(str_detect(Team, "Rahal|Letterman|Lanigan") ~ "RLL",
                           str_detect(Team, "Andretti") ~ "Andretti",
                           str_detect(Team, "Foyt") ~ "Foyt",
                           str_detect(Team, "Ganassi") ~ "Ganassi",
                           str_detect(Team, "Coyne") ~ "Coyne",
                           str_detect(Team, "Penske") ~ "Penske",
                           str_detect(Team, "Arrow|McLaren") ~ "Arrow McLaren",
                           str_detect(Team, "Carpenter") ~ "Carpenter",
                           str_detect(Team, "Carlin") ~ "Carlin",
                           str_detect(Team, "Schmidt Peterson") ~ "Schmidt Peterson",
                           TRUE ~ "Small Team"))

# Format dates as dates
results_history <- results_history %>% 
  mutate(date = as_date(date, format = "%m/%d/%Y"))

# Format elo dates as dates
elo <- elo %>% 
  mutate(date = as_date(date))

# Calculate years of experience for each driver each year (starting in 2008)
years_experience <- elo %>% 
  filter(year != 2000) %>% 
  group_by(driver, year) %>% 
  slice_max(order_by = date, n = 1) %>% 
  group_by(driver) %>% 
  mutate(first_year = min(year),
         experience = year - first_year + 1) %>% 
  select(driver, year, experience)

# Calculate total races experience each race per driver
races_experience <- elo %>% 
  filter(year != 2000) %>% 
  mutate(id = 1) %>% 
  group_by(driver) %>% 
  mutate(n_races = cumsum(id)) %>% 
  select(driver, date, year, n_races)
```

## Create dataset for predictions by joins
```{r}
# Join all data together with race results history
df_start <- results_history %>% 
  left_join(elo, by = c("driver", "date", "year")) %>% 
  left_join(years_experience, by = c("driver", "year")) %>% 
  left_join(team_history, by = c("driver" = "Driver", "year" = "year")) %>% 
  left_join(races_experience, by = c('driver' = 'driver', 'date' = 'date', "year" = "year")) %>% 
  group_by(driver, raceNumber, year) %>% 
  mutate(count = n()) %>% 
  filter(count == 1)

# Use previouselo as prerace elo for predictions
```

## Explore data
```{r}
plot(df_start$fin, df_start$st)

plot(as.factor(df_start$owner), df_start$fin)

plot(as.factor(df_start$Engine), df_start$fin)

plot(df_start$n_races, df_start$fin)

# Convert all non-numeric columns to factors for plotting
# df_start[,!sapply(df_start, is.numeric)] <- lapply(df_start[,!sapply(df_start, is.numeric)], as.factor)

df_start %>% 
  ungroup() %>% 
  select(type, fin, st, driver, PreviousEloRating, experience, Engine, Rounds, owner) %>% 
  mutate(across(.cols = !(where(is.numeric)), .fns = as.factor)) %>% 
  plot()

# Clean up options for rounds
df_start <- df_start %>% 
  select(type, st, driver, PreviousEloRating, experience, owner, Engine, Rounds, fin, n_races) %>% 
  mutate(Rounds = case_when(Rounds %in% c("Full Season", "Full Season.") ~ "Full",
                            is.na(Rounds) ~ "Full",
                            Rounds == "Ovals" ~ "Ovals",
                            TRUE ~ "Partial"))

```

## Build CV Models
### Ridge
```{r}
library(glmnet)

df_clean <- na.omit(df_start)

x <- model.matrix(fin ~ type + st + driver + PreviousEloRating + experience + owner + Engine + Rounds + n_races, df_clean)[,-1]

y <- df_clean %>% ungroup() %>% select(fin) %>% as.matrix()

set.seed(1)

cv.out <- cv.glmnet(x = x, y = y, alpha = 0)

plot(cv.out)

best_lam <- cv.out$lambda.min

cv.out

# predict(cv.out, "coefficients", s = best_lam)
```
### Lasso
```{r}
set.seed(1)

cv.out <- cv.glmnet(x = x, y = y, alpha = 1)

plot(cv.out)

best_lam <- cv.out$lambda.min

cv.out
```

There's no significant difference between Lasso and Ridge models, but the Lasso model is simpler with 76 variables at the min. lambda value so would be preferable.

```{r}
coef(cv.out, s = best_lam)
```
Let's try with less variables and see the impact.
```{r}
x <- model.matrix(fin ~ type + st + PreviousEloRating + experience + owner + Engine + Rounds + n_races, df_clean)[,-1]

y <- df_clean %>% ungroup() %>% select(fin) %>% as.matrix()

set.seed(1)

cv.out <- cv.glmnet(x = x, y = y, alpha = 0)

plot(cv.out)

best_lam <- cv.out$lambda.min

cv.out

coef(cv.out, s = best_lam)
```
There's fairly minimal impact to the predictive power by removing driver, which may help with overfitting, especially when you consider that most of the drivers which turn into dummy variables don't drive and haven't driven in years.
